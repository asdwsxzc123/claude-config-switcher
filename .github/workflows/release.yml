name: Release and Publish

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.2.0

jobs:
  release-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º Release

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆ changelog

    - name: å®‰è£… pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
        cache: 'pnpm'

    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ª tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -z "$PREV_TAG" ]; then
          # å¦‚æœæ˜¯ç¬¬ä¸€ä¸ª tagï¼Œè·å–æ‰€æœ‰æäº¤
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„æäº¤
          CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: å®‰è£…ä¾èµ–
      run: pnpm install --frozen-lockfile

    - name: è¯­æ³•æ£€æŸ¥
      run: |
        node -c index.js
        node -c lib/multiPlatformConfig.js
        node -c lib/config.js

    - name: å‘å¸ƒåˆ° NPM
      run: pnpm publish --no-git-checks
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.tag }}
        body: |
          ## ğŸ“¦ æ›´æ–°å†…å®¹

          ${{ steps.changelog.outputs.changelog }}

          ## ğŸš€ å®‰è£…æ–¹å¼

          ```bash
          npm install -g claude-code-switcher@${{ steps.get_version.outputs.version }}
          # æˆ–
          pnpm add -g claude-code-switcher@${{ steps.get_version.outputs.version }}
          ```

          ## ğŸ“– æ–‡æ¡£

          æŸ¥çœ‹ [README](https://github.com/${{ github.repository }}) äº†è§£ä½¿ç”¨æ–¹æ³•ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: é€šçŸ¥å‘å¸ƒæˆåŠŸ
      if: success()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… å‘å¸ƒæˆåŠŸï¼"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
        echo "NPM: https://www.npmjs.com/package/claude-code-switcher"
        echo "Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag }}"
