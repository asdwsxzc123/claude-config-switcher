name: Manual Publish to NPM

on:
  workflow_dispatch:  # 仅允许手动触发
    inputs:
      version:
        description: '版本号（可选，留空则使用 package.json 中的版本）'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: 安装 pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9

    - name: 设置 Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        cache: 'pnpm'

    - name: 获取版本信息
      id: version
      run: |
        PKG_VERSION=$(node -p "require('./package.json').version")
        echo "package_version=$PKG_VERSION" >> $GITHUB_OUTPUT
        echo "当前 package.json 版本: $PKG_VERSION"

    - name: 安装依赖
      run: pnpm install --frozen-lockfile

    - name: 语法检查
      run: |
        node -c index.js
        node -c lib/multiPlatformConfig.js
        node -c lib/config.js

    - name: 配置 NPM 认证
      run: |
        echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM1 }}

    - name: 发布到 NPM
      run: pnpm publish --no-git-checks

    - name: 通知发布成功
      if: success()
      run: |
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "✅ 手动发布到 NPM 成功！"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "版本: ${{ steps.version.outputs.package_version }}"
        echo "NPM: https://www.npmjs.com/package/claude-code-switcher"
        echo ""
        echo "⚠️  注意: 这是手动发布，通常应该使用 /release skill 来自动发布"
